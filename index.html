<html><head><base href="https://example.com">
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>RACHA PELADA UNIÃO</title>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
<script src="https://unpkg.com/xlsx/dist/xlsx.full.min.js"></script>
<style>
    body {
        font-family: 'Roboto', sans-serif;
        background-color: #ffffff;
        color: #000000;
        font-size: 14px; 
    }

    .floating-counts-window {
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: rgba(255, 255, 255, 0.95);
        border: 1px solid #ccc;
        border-radius: 8px;
        padding: 10px;
        z-index: 1000;
        cursor: move;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        display: none;
        user-select: none;
        -webkit-user-select: none;
    }

    .floating-counts-window .close-btn {
        position: absolute;
        right: 5px;
        top: 5px;
        cursor: pointer;
        font-size: 18px;
        color: #666;
    }

    .toggle-counts {
        cursor: pointer;
        margin-left: 5px;
        font-size: 12px;
        color: #666;
    }

.position-counts {
    background: #f8f9fa;
    padding: 5px 10px;
    border-radius: 4px;
    min-width: 200px;
    font-size: 10px; /* Set consistent base font size */
}

.position-counts .d-flex {
    margin-bottom: 2px;
    width: 100%;
}

.position-counts .d-flex > div {
    font-size: 10px; /* Ensure all text is the same size */
    line-height: 1.2;
    padding: 2px 0;
}

/* Make the header line (Time Azul/Laranja) slightly bigger */
.position-counts div:first-child {
    font-size: 11px;
    font-weight: bold;
    margin-bottom: 3px;
    width: 100%;
}

/* Style for the totals row */
.position-counts .d-flex:last-child {
    font-size: 10px;
    margin-top: 2px;
    padding-top: 2px;
}

/* Ensure even spacing between columns */
.position-counts .d-flex > div {
    flex: 1;
    text-align: left;
}

.position-counts .d-flex > div:last-child {
    text-align: right;
}


    .navbar {
        background-color: #000000;
    }
    .nav-link, .navbar-brand {
        color: #ffffff !important;
    }
    .nav-link.active {
        background-color: #ffffff !important;
        color: #000000 !important;
    }
    .nav-tabs .nav-link {
        color: #ffffff;
        background-color: #333333;
        border: 1px solid #444444;
        font-size: 14px;
    }
    .nav-tabs .nav-link.active {
        color: #ffffff;
        background-color: #222222;
        border-color: #444444;
    }
    .nav-tabs .nav-link:hover:not(.active) {
        background-color: #444444;
        border-color: #555555;
    }
    .tab-pane {
        background-color: #ffffff;
        border: 1px solid #ddd;
        color: #000000;
        border-radius: 0.25rem;
        padding: 20px;
    }
    .container {
        max-width: 960px;  
        margin: 0 auto;
        padding: 0 15px;
    }
    .player-item, .time-item {
        background-color: #ffffff;
        color: #000000;
        border: 1px solid #ddd;
        border-radius: 8px;
        padding: 12px;
        margin-bottom: 10px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        transition: transform 0.2s;
    }
    .player-item:hover, .time-item:hover {
        transform: translateY(-2px);
    }
    .btn-secondary, .btn-primary, .btn-success {
        margin-right: 5px;
    }
    .import-export-buttons {
        margin-bottom: 15px;
    }
    .import-export-buttons .btn {
        margin-right: 5px;  
        padding: 4px 8px;   
        font-size: 12px;    
    }
    .import-export-buttons .fas {
        font-size: 11px;    
    }
    #fileInput {
        display: none;
    }
    #searchResults {
        margin-top: 0.5rem;
        position: relative;
        width: 100%;
        max-width: 100%;
    }
    .input-group {
        position: relative;
        width: 100%;
        max-width: 100%;
    }
    .form-control, .form-select {
        background-color: #ffffff;
        border-color: #ddd;
        color: #000000;
        font-size: 14px;
    }
    .form-control:focus, .form-select:focus {
        background-color: #ffffff;
        border-color: #aaa;
        color: #000000;
    }
    .input-group-text {
        background-color: #f5f5f5;
        border-color: #ddd;
        color: #000000;
        font-size: 14px;
    }
    .list-group-item {
        background-color: #ffffff;
        border-color: #ddd;
        color: #000000;
    }
    .tab-pane h3, .tab-pane h5, 
    .player-item span, 
    .list-group-item,
    .table {
        color: #000000 !important;
    }
    .table {
        --bs-table-color: #000000;
        --bs-table-bg: #ffffff;
        --bs-table-border-color: #ddd;
        font-size: 14px;
    }
    .table-responsive {
        width: 100%;
        margin: 0 auto;
    }
    .table thead th {
        background-color: #f5f5f5;
        border-color: #ddd;
    }
    .table tbody td {
        border-color: #ddd;
        position: relative;
        padding: 12px;
        text-align: center;
        vertical-align: middle;
    }
    h3 {
        font-size: 1.5rem;
    }
    h5 {
        font-size: 1.1rem;
    }
    .btn {
        font-size: 14px;
    }
    .priority-badge {
        font-size: 8px;
        background-color: gold;
        color: #000000;
        font-weight: bold;
        margin-bottom: 2px;
        padding: 1px 4px;
        border-radius: 2px;
        display: inline-block;
        position: absolute; 
        top: 0;           
        right: 0;         
    }
    input[type="text"],
    input[type="number"],
    input[type="time"],
    select,
    textarea {
        font-size: 16px !important; 
        max-height: 100%;
        -webkit-text-size-adjust: 100%;
    }

    .form-control-sm {
        height: calc(1.5em + 0.5rem + 2px);
        padding: 0.25rem 0.5rem;
        font-size: 0.875rem;
    }

    .input-group-sm .form-control {
        height: calc(1.5em + 0.5rem + 2px);
        padding: 0.25rem 0.5rem;
        font-size: 0.875rem;
    }

    .btn-sm {
        padding: 0.25rem 0.5rem;
        font-size: 0.875rem;
    }

    .list-group-item .row {
        margin-left: -5px;
        margin-right: -5px;
    }

    .list-group-item .col-6 {
        padding-left: 5px;
        padding-right: 5px;
    }

    .teams-container {
        display: flex;
        flex-wrap: wrap;
        gap: 20px;
        margin: 0 -10px;
    }

    .teams-container .col-md-6 {
        flex: 1;
        min-width: 280px;
        padding: 15px;
        background-color: #f8f9fa;
        border-radius: 8px;
        margin-bottom: 15px;
    }

    .teams-container h5 {
        color: #000;
        font-size: 1.2rem;
        margin-bottom: 15px;
        padding-bottom: 10px;
        border-bottom: 2px solid #dee2e6;
    }

    .teams-container .list-group-item {
        background-color: #fff;
        border: 1px solid rgba(0,0,0,.125);
        margin-bottom: 8px;
        border-radius: 6px;
        padding: 12px 15px;
    }

    /* Blue team specific styles */
    #blueTeam .list-group-item {
        border-left: 4px solid #0d6efd;
    }

    /* Orange team specific styles */
    #orangeTeam .list-group-item {
        border-left: 4px solid #fd7e14;
    }

    @media screen and (max-width: 768px) {
        .teams-container {
            margin: 0;
        }
        
        .teams-container .col-md-6 {
            min-width: calc(50% - 10px);
            padding: 10px;
        }
    }

    .btn-group .btn-sm {
        padding: 0.25rem 0.5rem;
        font-size: 0.75rem;
    }

</style>
</head>
<body>

<nav class="navbar navbar-expand-lg navbar-dark">
    <div class="container">
        <a class="navbar-brand" href="https://example.com"><i class="fas fa-futbol me-2"></i>RACHA PELADA UNIÃO</a>
        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
            <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarNav">
            <ul class="navbar-nav" role="tablist">
                <li class="nav-item">
                    <button class="nav-link active" data-bs-toggle="tab" data-bs-target="#jogadores" type="button" role="tab">Jogadores</button>
                </li>
                <li class="nav-item">
                    <button class="nav-link" data-bs-toggle="tab" data-bs-target="#listaChegada" type="button" role="tab">Lista de Chegada</button>
                </li>
                <li class="nav-item">
                    <button class="nav-link" data-bs-toggle="tab" data-bs-target="#times" type="button" role="tab">Times</button>
                </li>
                <li class="nav-item">
                    <button class="nav-link" data-bs-toggle="tab" data-bs-target="#golsCartoes" type="button" role="tab">Gols/Cartões</button>
                </li>
                <li class="nav-item">
                    <button class="nav-link" data-bs-toggle="tab" data-bs-target="#financeiro" type="button" role="tab">Financeiro</button>
                </li>
                <li class="nav-item">
                    <button class="nav-link" data-bs-toggle="tab" data-bs-target="#regulamento" type="button" role="tab">Regulamento</button>
                </li>
            </ul>
        </div>
    </div>
</nav>

<div class="container my-4">
    <div class="tab-content">
        <!-- Aba Jogadores -->
        <div class="tab-pane fade show active" id="jogadores" role="tabpanel">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h3>Cadastro de Jogadores</h3>
            </div>
            <div class="input-group mb-3">
                <span class="input-group-text"><i class="fas fa-search"></i></span>
                <input type="text" id="playerSearchInput" class="form-control" placeholder="Buscar jogador">
            </div>
            <form id="playerForm" class="mb-3">
                <input type="text" id="playerName" class="form-control mb-2" placeholder="Nome" required>
                <select id="playerPosition" class="form-select mb-2" required>
                    <option value="">Posição</option>
                    <option value="ATA">ATA</option>
                    <option value="ZAG">ZAG</option>
                    <option value="LAT">LAT</option>
                    <option value="MEI">MEI</option>
                    <option value="VOL">VOL</option>
                    <option value="GOL">GOL</option>
                </select>
                <select id="playerType" class="form-select mb-2" required>
                    <option value="">Tipo</option>
                    <option value="M">M</option>
                    <option value="D">D</option>
                </select>
                <div class="d-flex gap-2">
                    <button type="submit" class="btn btn-primary">Cadastrar</button>
                    <input type="file" id="fileInput" accept=".xlsx,.xls" style="display: none">
                    <button type="button" class="btn btn-success" onclick="document.getElementById('fileInput').click()">
                        <i class="fas fa-file-import"></i> Importar
                    </button>
                    <button type="button" class="btn btn-info text-white" onclick="exportToExcel()">
                        <i class="fas fa-file-export"></i> Exportar
                    </button>
                    <button type="button" class="btn btn-danger" onclick="clearAllPlayers()">
                        <i class="fas fa-trash-alt"></i> Apagar Tudo
                    </button>
                </div>
            </form>
            <div id="playerList" class="list-group"></div>
        </div>

        <!-- Aba Lista de Chegada -->
        <div class="tab-pane fade" id="listaChegada" role="tabpanel">
            <h3>Lista de Chegada</h3>
            <div class="input-group mb-2">
                <span class="input-group-text"><i class="fas fa-search"></i></span>
                <input type="text" id="searchPlayer" class="form-control" placeholder="Buscar jogador">
            </div>
            <button class="btn btn-danger mb-3 ms-2" onclick="clearAllLists()">
                <i class="fas fa-trash-alt"></i> Limpar Listas
            </button>
            <div id="searchResults"></div>

            <ul class="nav nav-tabs mb-3" role="tablist">
                <li class="nav-item" role="presentation">
                    <button class="nav-link active" data-bs-toggle="tab" data-bs-target="#primeiroTempo" type="button" role="tab">1º Tempo</button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" data-bs-toggle="tab" data-bs-target="#segundoTempo" type="button" role="tab">2º Tempo</button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" data-bs-toggle="tab" data-bs-target="#goleiros" type="button" role="tab">Goleiros</button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" data-bs-toggle="tab" data-bs-target="#timesTab" type="button" role="tab">Times</button>
                </li>
            </ul>

            <div class="tab-content">
                <div class="tab-pane fade show active" id="primeiroTempo" role="tabpanel">
                    <h5>1º Tempo</h5>
                    <div id="firstHalfList" class="list-group"></div>
                </div>
                <div class="tab-pane fade" id="segundoTempo" role="tabpanel">
                    <h5>2º Tempo</h5>
                    <div id="secondHalfList" class="list-group"></div>
                </div>
                <div class="tab-pane fade" id="goleiros" role="tabpanel">
                    <h5>Goleiros</h5>
                    <div id="goalkeeperList" class="list-group"></div>
                </div>
                <div class="tab-pane fade" id="timesTab" role="tabpanel">
                    <h3 class="mb-4">Times 1º Tempo</h3>
                    <div class="teams-container">
                        <div class="col-md-6">
                            <h5>Time Azul</h5>
                            <div id="blueTeamCopy"></div>
                        </div>
                        <div class="col-md-6">
                            <h5>Time Laranja</h5>
                            <div id="orangeTeamCopy"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Aba Times -->
        <div class="tab-pane fade" id="times" role="tabpanel">
            <!-- First half teams -->
            <h3 class="mb-4">Times 1º Tempo</h3>
            <div class="teams-container">
                <div class="col-md-6">
                    <h5>Time Azul</h5>
                    <div id="blueTeam"></div>
                </div>
                <div class="col-md-6">
                    <h5>Time Laranja</h5>
                    <div id="orangeTeam"></div>
                </div>
            </div>

            <div class="text-center my-4">
                <button class="btn btn-primary" onclick="generateSecondHalfTeams()">
                    <i class="fas fa-clock"></i> Gerar Times 2º Tempo
                </button>
            </div>

            <!-- Second half teams -->
            <div id="secondHalfTeamsContainer" style="display: none;">
                <h3 class="mb-4">Times 2º Tempo</h3>
                <div class="teams-container">
                    <div class="col-md-6">
                        <h5>Time Azul</h5>
                        <div id="blueTeamSecond"></div>
                    </div>
                    <div class="col-md-6">
                        <h5>Time Laranja</h5>
                        <div id="orangeTeamSecond"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Aba Gols/Cartões -->
        <div class="tab-pane fade" id="golsCartoes" role="tabpanel">
            <h3>Gols/Cartões</h3>
            <div class="row">
                <div class="col-md-6">
                    <h5>Artilharia</h5>
                    <div class="table-responsive">
                        <table class="table table-striped">
                            <thead>
                                <tr>
                                    <th>Jogador</th>
                                    <th>Gols</th>
                                    <th>Ações</th>
                                </tr>
                            </thead>
                            <tbody id="scorersList"></tbody>
                        </table>
                    </div>
                    <button class="btn btn-primary mb-3" data-bs-toggle="modal" data-bs-target="#addGoalModal">
                        <i class="fas fa-plus"></i> Adicionar Gol
                    </button>
                </div>
                <div class="col-md-6">
                    <h5>Cartões</h5>
                    <div class="table-responsive">
                        <table class="table table-striped">
                            <thead>
                                <tr>
                                    <th>Jogador</th>
                                    <th>Amarelos</th>
                                    <th>Vermelhos</th>
                                    <th>Ações</th>
                                </tr>
                            </thead>
                            <tbody id="cardsList"></tbody>
                        </table>
                    </div>
                    <button class="btn btn-primary mb-3" data-bs-toggle="modal" data-bs-target="#addCardModal">
                        <i class="fas fa-plus"></i> Adicionar Cartão
                    </button>
                </div>
            </div>
        </div>

        <!-- Aba Financeiro -->
        <div class="tab-pane fade" id="financeiro" role="tabpanel">
            <h3>Financeiro</h3>
            <div class="row">
                <div class="col-md-6">
                    <div class="card mb-3">
                        <div class="card-body">
                            <h5 class="card-title">Resumo</h5>
                            <table class="table">
                                <tr>
                                    <td>Total Mensalistas:</td>
                                    <td id="totalMensalistas">R$ 0,00</td>
                                </tr>
                                <tr>
                                    <td>Total Diaristas:</td>
                                    <td id="totalDiaristas">R$ 0,00</td>
                                </tr>
                                <tr>
                                    <td>Total Geral:</td>
                                    <td id="totalGeral">R$ 0,00</td>
                                </tr>
                            </table>
                        </div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-body">
                            <h5 class="card-title">Pagamentos</h5>
                            <div id="pagamentosList"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Aba Regulamento -->
        <div class="tab-pane fade" id="regulamento" role="tabpanel">
            <h3 class="text-center mb-4">REGULAMENTO PARA PARTICIPAR DO RACHA PELADA UNIÃO</h3>
            
            <div class="card mb-4">
                <div class="card-body">
                    <h5 class="card-title">REGRAS PARA FORMAÇÃO DOS TIMES</h5>
                    <p>Os times serão formados por 2 participantes desde que os mesmos estejam na ordem de entrada e em dias com o racha. Na entrada dos times, começa tirando aquele que ganhar o cara ou coroa.</p>
                    <p>Os primeiros 20 atletas que chegarem ao campo e que estiverem em dias com o racha começarão jogando de saída.</p>
                    <p><em>OBS: É obrigação do atleta na chegada, ir até o responsável pela lista para quitar possíveis débitos e assim validar sua presença.</em></p>

                    <p>Para que os atletas possam começar jogando, o mesmo terá que obedecer às seguintes regras:</p>
                    <ul class="list-group list-group-flush mb-3">
                        <li class="list-group-item">Estar em dias com o limite de débito no máximo de dez reais (R$10,00)</li>
                        <li class="list-group-item">Estar na ordem de chegada</li>
                        <li class="list-group-item">Estar devidamente uniformizado com colete padronizado pelo racha</li>
                        <li class="list-group-item">Não estar com sintomas de embriaguez</li>
                        <li class="list-group-item">Não estar com chuteiras de trava ou descalço</li>
                    </ul>
                </div>
            </div>

            <div class="card mb-4">
                <div class="card-body">
                    <h5 class="card-title">RESERVAS E SUBSTITUIÇÕES</h5>
                    <p>Os atletas que começarem jogando no primeiro tempo, poderão ser substituídos no segundo tempo, dependendo do número de atletas que estejam na reserva e em dias com o racha, sempre respeitando a ordem de chegada.</p>
                    <p>O time que estiver perdendo no término do primeiro tempo terá o direito de escolher o primeiro reserva. Em caso de empate, será decidido quem escolhe primeiro no cara ou coroa.</p>
                    <p>O atleta não poderá jogar em outro time que não seja o que o mesmo começou jogando.</p>
                </div>
            </div>

            <div class="card mb-4">
                <div class="card-body">
                    <h5 class="card-title">CONVIDADOS</h5>
                    <p>Todos os atletas poderão levar convidados para o racha, desde que o mesmo pague o valor da diária estabelecida. Todos os convidados só poderão jogar de saída se os mensalistas e diaristas não estiverem na ordem de chegada.</p>
                    <p>Será de responsabilidade do atleta do racha, possíveis cartões que seu convidado venha a tomar durante a partida.</p>
                    <p>A partir do segundo racha, o convidado já poderá entrar de saída, desde que tenha pago seu colete e esteja em dias com o racha.</p>
                </div>
            </div>

            <div class="card mb-4">
                <div class="card-body">
                    <h5 class="card-title">OPÇÕES PARA PARTICIPAÇÃO</h5>
                    <ul class="list-group list-group-flush mb-3">
                        <li class="list-group-item"><strong>Diarista:</strong> R$ 10,00</li>
                        <li class="list-group-item"><strong>Mensalista:</strong> R$ 40,00</li>
                    </ul>
                    <p>O mensalista fará seu pagamento no primeiro domingo de cada mês, tendo a opção de pagar R$10,00 no primeiro domingo e quitar o restante no seguinte.</p>
                    <p>A prioridade do mensalista é até as 6:30 da manhã, os mesmo terão prioridade sobre os dariaristas que chegarem antes do mesmo até esse horário.</p>
                    <p>Após o horário de 6:00, o mensalista entrará na ordem como os diaristas.</p>
                </div>
            </div>

            <div class="card mb-4">
                <div class="card-body">
                    <h5 class="card-title">CARTÕES</h5>
                    <ul class="list-group list-group-flush mb-3">
                        <li class="list-group-item">Cartão amarelo: R$ 3,00</li>
                        <li class="list-group-item">Cartão azul: R$ 4,00 (o atleta fica fora do jogo por 5 minutos)</li>
                        <li class="list-group-item">Cartão vermelho: R$ 5,00 (o atleta está fora do jogo, podendo seu time colocar outro após 5 minutos)</li>
                    </ul>
                    <p>Todos os cartões deverão ser pagos no domingo seguinte. É expressamente proibido qualquer tipo de agressão, violência e ameaças a qualquer participante do racha ou arbitragem dentro da areninha.</p>
                </div>
            </div>

            <div class="card mb-4">
                <div class="card-body">
                    <h5 class="card-title">GOLEIROS</h5>
                    <p>Os goleiros serão remunerados de acordo com a sua opção:</p>
                    <ul class="list-group list-group-flush mb-3">
                        <li class="list-group-item">Receber o valor de R$ 10,00 por tempo jogado</li>
                        <li class="list-group-item">Ter o direito de participar da confraternização, podendo levar esposa ou namorada e filhos menores de 12 anos (necessário ter presença de pelo menos 70% dos rachadas)</li>
                    </ul>
                    <p>Os goleiros não são isentos das multas referentes a cartões.</p>
                </div>
            </div>

            <div class="card mb-4">
                <div class="card-body">
                    <h5 class="card-title">EVENTOS E CONFRATERNIZAÇÃO</h5>
                    <p>Somente terão direito a participar de eventos organizados pelo racha os atletas que estejam participando do racha no mínimo de 3 meses ou atletas afastados por contusões comprovadas.</p>
                    <p>Somente poderão estar presente a confraternização os atletas que tiverem feito sua contribuição alongo ao racha de no mínimo 70% em suas mensalidades, caso não atinja esse percentual o atleta tem a opção de complementar o valor restante, caso queira participar.</p>
                </div>
            </div>

            <div class="card mb-4">
                <div class="card-body">
                    <h5 class="card-title">CASOS EXTRAS</h5>
                    <p>Casos extras que venham a ocorrer e que não estejam neste regulamento serão colocados em votação e acrescentados.</p>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="modal" id="addPlayerModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Editar Jogador</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="editPlayerForm">
                    <div class="mb-3">
                        <label for="arrivalTime" class="form-label">Horário de Chegada</label>
                        <input type="time" class="form-control form-control-sm" id="arrivalTime" required>
                    </div>
                    <div class="mb-3">
                        <label for="price" class="form-label">Valor</label>
                        <input type="number" class="form-control form-control-sm" id="price">
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                <button type="button" class="btn btn-primary">Salvar</button>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
let players = JSON.parse(localStorage.getItem('players')) || [];
let firstHalfPlayers = JSON.parse(localStorage.getItem('firstHalfPlayers')) || [];
let secondHalfPlayers = JSON.parse(localStorage.getItem('secondHalfPlayers')) || [];
let goalkeeperPlayers = JSON.parse(localStorage.getItem('goalkeeperPlayers')) || [];
let blueTeam = JSON.parse(localStorage.getItem('blueTeam')) || [];
let orangeTeam = JSON.parse(localStorage.getItem('orangeTeam')) || [];
let blueTeamSecond = JSON.parse(localStorage.getItem('blueTeamSecond')) || [];
let orangeTeamSecond = JSON.parse(localStorage.getItem('orangeTeamSecond')) || [];

function getTeamPositionCounts(team) {
    const counts = {
        ATA: 0,
        ZAG: 0,
        LAT: 0,
        MEI: 0,
        VOL: 0,
        GOL: 0
    };
    
    // Ensure team is an array before using forEach
    if (Array.isArray(team)) {
        team.forEach(player => {
            if (counts.hasOwnProperty(player.position)) {
                counts[player.position]++;
            }
        });
    }
    
    return counts;
}

function generateTeamCountsHTML(blueTeamCounts, orangeTeamCounts) {
    // Calculate totals
    const blueTotal = Object.values(blueTeamCounts).reduce((a, b) => a + b, 0);
    const orangeTotal = Object.values(orangeTeamCounts).reduce((a, b) => a + b, 0);
    
    return `
        <div class="position-counts">
            <div class="d-flex justify-content-between">
                <div><strong>Time Azul</strong></div>
                <div><strong>Time Laranja</strong></div>
            </div>
            <div class="d-flex justify-content-between">
                <div style="width: 50%">ATA: ${blueTeamCounts.ATA}</div>
                <div style="width: 50%">ATA: ${orangeTeamCounts.ATA}</div>
            </div>
            <div class="d-flex justify-content-between">
                <div style="width: 50%">ZAG: ${blueTeamCounts.ZAG}</div>
                <div style="width: 50%">ZAG: ${orangeTeamCounts.ZAG}</div>
            </div>
            <div class="d-flex justify-content-between">
                <div style="width: 50%">LAT: ${blueTeamCounts.LAT}</div>
                <div style="width: 50%">LAT: ${orangeTeamCounts.LAT}</div>
            </div>
            <div class="d-flex justify-content-between">
                <div style="width: 50%">MEI: ${blueTeamCounts.MEI}</div>
                <div style="width: 50%">MEI: ${orangeTeamCounts.MEI}</div>
            </div>
            <div class="d-flex justify-content-between">
                <div style="width: 50%">VOL: ${blueTeamCounts.VOL}</div>
                <div style="width: 50%">VOL: ${orangeTeamCounts.VOL}</div>
            </div>
            <div class="d-flex justify-content-between">
                <div style="width: 50%">GOL: ${blueTeamCounts.GOL}</div>
                <div style="width: 50%">GOL: ${orangeTeamCounts.GOL}</div>
            </div>
            <div class="d-flex justify-content-between" style="border-top: 1px solid #dee2e6; margin-top: 4px; padding-top: 4px;">
                <div style="width: 50%"><strong>Total: ${blueTotal}</strong></div>
                <div style="width: 50%"><strong>Total: ${orangeTotal}</strong></div>
            </div>
        </div>
    `;
}

// Initialize storage for goals and cards
let goals = JSON.parse(localStorage.getItem('goals')) || [];
let cards = JSON.parse(localStorage.getItem('cards')) || [];

function updateFinancialSummary() {
    const mensalistasPlayers = [...firstHalfPlayers, ...secondHalfPlayers, ...goalkeeperPlayers].filter(p => p.type === 'M');
    const diaristasPlayers = [...firstHalfPlayers, ...secondHalfPlayers, ...goalkeeperPlayers].filter(p => p.type === 'D');

    // Calculate totals based on price if set, otherwise use default values
    const totalMensalistas = mensalistasPlayers.reduce((acc, player) => {
        return acc + (player.price !== null ? Number(player.price) : 40);
    }, 0);

    const totalDiaristas = diaristasPlayers.reduce((acc, player) => {
        return acc + (player.price !== null ? Number(player.price) : 10);
    }, 0);

    const totalGeral = totalMensalistas + totalDiaristas;

    // Update the display elements if they exist
    const totalMensalistasElement = document.getElementById('totalMensalistas');
    if (totalMensalistasElement) {
        totalMensalistasElement.textContent = `R$ ${totalMensalistas.toFixed(2)}`;
    }

    const totalDiaristasElement = document.getElementById('totalDiaristas');
    if (totalDiaristasElement) {
        totalDiaristasElement.textContent = `R$ ${totalDiaristas.toFixed(2)}`;
    }

    const totalGeralElement = document.getElementById('totalGeral');
    if (totalGeralElement) {
        totalGeralElement.textContent = `R$ ${totalGeral.toFixed(2)}`;
    }

    // Update payments list if it exists
    const pagamentosList = document.getElementById('pagamentosList');
    if (pagamentosList) {
        const allPlayers = [...firstHalfPlayers, ...secondHalfPlayers, ...goalkeeperPlayers];
        pagamentosList.innerHTML = allPlayers
            .map(player => `
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <span>${player.name} (${player.type})</span>
                    <span>R$ ${(player.price !== null ? Number(player.price) : (player.type === 'M' ? 40 : 10)).toFixed(2)}</span>
                </div>
            `)
            .join('');
    }
}

function renderPlayerList(filteredPlayersList = players) {
    const playerList = document.getElementById("playerList");
    if (playerList) {
        playerList.innerHTML = filteredPlayersList.map(player => `
            <div class="player-item">
                <div>
                    <span>${player.name} - ${player.position}</span>
                    ${player.type ? `<small class="text-muted">(${player.type === 'M' ? 'Mensalista' : 'Diarista'})</small>` : ''}
                </div>
                <div>
                    <button class="btn btn-sm btn-outline-primary" onclick="editPlayer(${player.id})">
                        <i class="fas fa-edit"></i>
                    </button>
                    <button class="btn btn-sm btn-outline-danger" onclick="deletePlayer(${player.id})">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            </div>
        `).join('');
    }
}

function handlePlayerSearch(searchText) {
    const searchResults = document.getElementById('searchResults');
    const playerSearchInput = document.getElementById("playerSearchInput");
    
    if (playerSearchInput && playerSearchInput === document.activeElement) {
        const filteredPlayers = players.filter(player => 
            player.name.toLowerCase().includes(searchText.toLowerCase())
        );
        renderPlayerList(filteredPlayers);
        return;
    }

    if (!searchText.trim()) {
        searchResults.innerHTML = '';
        return;
    }

    const now = new Date();
    const hours = String(now.getHours()).padStart(2, '0');
    const minutes = String(now.getMinutes()).padStart(2, '0');
    const currentTime = `${hours}:${minutes}`;

    const existingPlayerIds = new Set([
        ...firstHalfPlayers.map(p => p.id),
        ...secondHalfPlayers.map(p => p.id),
        ...goalkeeperPlayers.map(p => p.id)
    ]);

    const filteredPlayers = players.filter(player => 
        player.name.toLowerCase().includes(searchText.toLowerCase()) &&
        !existingPlayerIds.has(player.id)
    );

    searchResults.innerHTML = filteredPlayers.length ? `
        <div class="list-group" style="width: 100%; max-width: 100%;">
            ${filteredPlayers.map(player => `
                <div class="list-group-item" style="width: 100%;">
                    <div class="d-flex flex-column">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <div>
                                <strong>${player.name}</strong> - ${player.position}
                                <small class="text-muted">(${player.type === 'M' ? 'Mensalista' : 'Diarista'})</small>
                            </div>
                        </div>
                        <div class="row g-2">
                            <div class="col-6">
                                <div class="input-group input-group-sm">
                                    <input type="time" class="form-control form-control-sm" 
                                           id="time-${player.id}" 
                                           value="${currentTime}"
                                           required>
                                </div>
                            </div>
                            <div class="col-6">
                                <div class="input-group input-group-sm">
                                    <input type="number" class="form-control form-control-sm" 
                                           id="price-${player.id}" 
                                           value="">
                                </div>
                            </div>
                        </div>
                        <div class="mt-2">
                            <button class="btn btn-sm btn-success" onclick="addPlayerToList(${player.id})">
                                <i class="fas fa-plus"></i> Adicionar
                            </button>
                        </div>
                    </div>
                </div>
            `).join('')}
        </div>
    ` : '<div class="alert alert-info">Nenhum jogador encontrado</div>';
}

function getTeamButtonStyle(team, playerId) {
    if (team === 'blue') {
        return blueTeam.some(p => p.id === playerId) ? 'btn-dark' : 'btn-outline-primary';
    } else if (team === 'orange') {
        return orangeTeam.some(p => p.id === playerId) ? 'btn-warning text-dark' : 'btn-outline-warning';
    }
    return '';
}

function addPlayerToList(playerId) {
    const player = players.find(p => p.id === playerId);
    const timeInput = document.getElementById(`time-${playerId}`);
    const priceInput = document.getElementById(`price-${playerId}`);
    
    if (!player || !timeInput.value) {
        alert('Por favor preencha o horário de chegada');
        return;
    }

    const arrivalTime = timeInput.value;
    const price = priceInput.value ? parseFloat(priceInput.value) : null;

    const playerWithDetails = {
        ...player,
        arrivalTime,
        price
    };

    // Check if player is mensalista with priority time
    const [hours, minutes] = arrivalTime.split(':').map(Number);
    const hasPriority = player.type === 'M' && (hours < 6 || (hours === 6 && minutes <= 30));

    const totalPlayers = firstHalfPlayers.length + secondHalfPlayers.length;

    if (player.position === 'GOL') {
        if (goalkeeperPlayers.length >= 4) {
            alert('Lista de Goleiros está cheia (limite de 4 jogadores)');
            return;
        }
        goalkeeperPlayers.push(playerWithDetails);
        localStorage.setItem('goalkeeperPlayers', JSON.stringify(goalkeeperPlayers));
    } else if (totalPlayers >= 40) {
        alert('Todas as listas de jogadores estão cheias (limite de 40 jogadores no total)');
        return;
    } else {
        // If player has priority, they should be added to the beginning of the appropriate list
        if (hasPriority) {
            if (firstHalfPlayers.length < 20) {
                firstHalfPlayers.unshift(playerWithDetails);
            } else {
                // Move last player from first half to second half
                const lastPlayer = firstHalfPlayers.pop();
                if (lastPlayer) {
                    secondHalfPlayers.unshift(lastPlayer);
                }
                firstHalfPlayers.unshift(playerWithDetails);
            }
        } else {
            // Regular non-priority addition
            if (firstHalfPlayers.length < 20) {
                firstHalfPlayers.push(playerWithDetails);
            } else {
                secondHalfPlayers.push(playerWithDetails);
            }
        }

        // Sort both lists by priority and time
        firstHalfPlayers.sort(sortByPriorityAndTime);
        secondHalfPlayers.sort(sortByPriorityAndTime);

        localStorage.setItem('firstHalfPlayers', JSON.stringify(firstHalfPlayers));
        localStorage.setItem('secondHalfPlayers', JSON.stringify(secondHalfPlayers));
    }

    document.getElementById('searchPlayer').value = '';
    document.getElementById('searchResults').innerHTML = '';

    renderArrivalLists();
    updateFinancialSummary();
}

// Update the sortByPriorityAndTime function to apply priority rules across both lists
function sortByPriorityAndTime(a, b) {
    const aTime = a.arrivalTime || "23:59";
    const bTime = b.arrivalTime || "23:59";
    const [aHours, aMinutes] = aTime.split(':').map(Number);
    const [bHours, bMinutes] = bTime.split(':').map(Number);
    
    // Priority rule: Mensalistas arriving before 6:30
    const aIsPriority = a.type === 'M' && (aHours < 6 || (aHours === 6 && aMinutes <= 30));
    const bIsPriority = b.type === 'M' && (bHours < 6 || (bHours === 6 && bMinutes <= 30));
    
    if (aIsPriority !== bIsPriority) {
        return aIsPriority ? -1 : 1;
    }
    
    return aTime.localeCompare(bTime);
}

// Update removeFromList function
window.removeFromList = function(listType, playerId) {
    if (!confirm('Tem certeza que deseja remover este jogador da lista? Esta ação não pode ser desfeita.')) {
        return;
    }
    
    switch(listType) {
        case 'first':
            // Remove from first half
            firstHalfPlayers = firstHalfPlayers.filter(p => p.id !== playerId);
            
            // If there are players in second half, promote the first one
            if (secondHalfPlayers.length > 0) {
                const promotedPlayer = secondHalfPlayers.shift(); // Remove and get first player
                firstHalfPlayers.push(promotedPlayer); // Add to first half
            }
            
            break;
        case 'second':
            secondHalfPlayers = secondHalfPlayers.filter(p => p.id !== playerId);
            break;
        case 'goalkeeper':
            goalkeeperPlayers = goalkeeperPlayers.filter(p => p.id !== playerId);
            break;
    }
    
    // Save updated lists to localStorage
    localStorage.setItem('firstHalfPlayers', JSON.stringify(firstHalfPlayers));
    localStorage.setItem('secondHalfPlayers', JSON.stringify(secondHalfPlayers));
    localStorage.setItem('goalkeeperPlayers', JSON.stringify(goalkeeperPlayers));
    
    renderArrivalLists();
};

// Update secondHalfList rendering in renderArrivalLists function
function renderArrivalLists() {
    const positions = ['Todos', 'ATA', 'ZAG', 'LAT', 'MEI', 'VOL'];
    
    function sortByPriorityAndTime(a, b) {
        const aTime = a.arrivalTime || "23:59";
        const bTime = b.arrivalTime || "23:59";
        const [aHours, aMinutes] = aTime.split(':').map(Number);
        const [bHours, bMinutes] = bTime.split(':').map(Number);
        
        const aIsPriority = a.type === 'M' && (aHours < 6 || (aHours === 6 && aMinutes <= 30));
        const bIsPriority = b.type === 'M' && (bHours < 6 || (bHours === 6 && bMinutes <= 30));
        
        if (aIsPriority === bIsPriority) {
            return aTime.localeCompare(bTime);
        }
        return aIsPriority ? -1 : 1;
    }

    // Sort the lists applying priority rules
    firstHalfPlayers.sort(sortByPriorityAndTime);
    secondHalfPlayers.sort(sortByPriorityAndTime);
    
    // Update localStorage with sorted lists
    localStorage.setItem('firstHalfPlayers', JSON.stringify(firstHalfPlayers));
    localStorage.setItem('secondHalfPlayers', JSON.stringify(secondHalfPlayers));

    const firstHalfList = document.getElementById("firstHalfList");
    const secondHalfList = document.getElementById("secondHalfList");
    const goalkeeperList = document.getElementById("goalkeeperList");

    if (firstHalfList) {
        const blueTeamCounts = getTeamPositionCounts(Array.isArray(blueTeam) ? blueTeam : []);
        const orangeTeamCounts = getTeamPositionCounts(Array.isArray(orangeTeam) ? orangeTeam : []);

        firstHalfList.innerHTML = `
            <div class="d-flex justify-content-between align-items-start mb-2">
                <div>
                    <h6>
                        Jogadores: ${firstHalfPlayers.length}/20
                        <i class="fas fa-chart-bar toggle-counts" onclick="showPositionCounts()" title="Ver contagem de posições"></i>
                    </h6>
                </div>
            </div>
            <div class="btn-group mb-3" role="group" aria-label="Position filters">
                ${positions.map(pos => `
                    <button type="button" class="btn btn-sm btn-outline-secondary position-filter" 
                            data-list="first" data-position="${pos}">
                        ${pos}
                    </button>
                `).join('')}
            </div>
            <table class="table table-light table-striped">
                <thead>
                    <tr>
                        <th>#</th>
                        <th>Nome</th>
                        <th>Posição</th>
                        <th>Horário</th>
                        <th>Valor</th>
                    </tr>
                </thead>
                <tbody>
                    ${firstHalfPlayers.map((player, index) => {
                        const arrivalTime = player.arrivalTime || "";
                        const [hours, minutes] = arrivalTime.split(':').map(Number);
                        const isPriority = player.type === 'M' && 
                            (hours < 6 || (hours === 6 && minutes <= 30));
                        
                        const typeLabel = player.type === 'M' ? 'Mensalista' : player.type === 'D' ? 'Diarista' : '';
                        
                        return `
                            <tr>
                                <td>${index + 1}</td>
                                <td style="position: relative; padding-top: 16px;">
                                    ${isPriority ? '<div class="priority-badge">Prioridade Mensalista</div>' : ''}
                                    ${player.name}
                                    ${typeLabel ? `<div><small class="text-muted">(${typeLabel})</small></div>` : ''}
                                </td>
                                <td>${player.position}</td>
                                <td>${player.arrivalTime || '-'}</td>
                                <td>${player.price !== null ? `R$ ${Number(player.price || (player.type === 'M' ? 40 : 10)).toFixed(2)}` : '-'}</td>
                            </tr>
                            <tr>
                                <td colspan="5" class="text-center">
                                    <button class="btn btn-sm ${getTeamButtonStyle('blue', player.id)}" onclick="addToTeam('blue', ${player.id})">
                                        <i class="fas fa-tshirt"></i>
                                    </button>
                                    <button class="btn btn-sm ${getTeamButtonStyle('orange', player.id)}" onclick="addToTeam('orange', ${player.id})">
                                        <i class="fas fa-tshirt"></i>
                                    </button>
                                    <button class="btn btn-sm btn-outline-primary" onclick="editPlayer(${player.id})">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                    <button class="btn btn-sm btn-outline-danger" onclick="removeFromList('first', ${player.id})">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </td>
                            </tr>
                        `;
                    }).join('')}
                </tbody>
            </table>
        `;
    }

    if (secondHalfList) {
        secondHalfList.innerHTML = `
            <div class="d-flex justify-content-between align-items-start mb-2">
                <div>
                    <h6>
                        Jogadores: ${firstHalfPlayers.length + secondHalfPlayers.length}/40
                        <i class="fas fa-chart-bar toggle-counts" onclick="showPositionCounts()" title="Ver contagem de posições"></i>
                    </h6>
                </div>
            </div>
            <div class="btn-group mb-3" role="group" aria-label="Position filters">
                ${positions.map(pos => `
                    <button type="button" class="btn btn-sm btn-outline-secondary position-filter" 
                            data-list="second" data-position="${pos}">
                        ${pos}
                    </button>
                `).join('')}
            </div>
            <table class="table table-light table-striped">
                <thead>
                    <tr>
                        <th>#</th>
                        <th>Nome</th>
                        <th>Posição</th>
                        <th>Horário</th>
                        <th>Valor</th>
                    </tr>
                </thead>
                <tbody>
                    ${secondHalfPlayers.map((player, index) => {
                        const arrivalTime = player.arrivalTime || "";
                        const [hours, minutes] = arrivalTime.split(':').map(Number);
                        const isPriority = player.type === 'M' && 
                            (hours < 6 || (hours === 6 && minutes <= 30));
                        
                        const typeLabel = player.type === 'M' ? 'Mensalista' : player.type === 'D' ? 'Diarista' : '';
                        
                        return `
                            <tr>
                                <td>${index + 21}</td>
                                <td style="position: relative; padding-top: 16px;">
                                    ${isPriority ? '<div class="priority-badge">Prioridade Mensalista</div>' : ''}
                                    ${player.name}
                                    ${typeLabel ? `<div><small class="text-muted">(${typeLabel})</small></div>` : ''}
                                </td>
                                <td>${player.position}</td>
                                <td>${player.arrivalTime || '-'}</td>
                                <td>${player.price !== null ? `R$ ${Number(player.price || (player.type === 'M' ? 40 : 10)).toFixed(2)}` : '-'}</td>
                            </tr>
                            <tr>
                                <td colspan="5" class="text-center">
                                    <button class="btn btn-sm ${getTeamButtonStyle('blue', player.id)}" onclick="addToTeam('blue', ${player.id})">
                                        <i class="fas fa-tshirt"></i>
                                    </button>
                                    <button class="btn btn-sm ${getTeamButtonStyle('orange', player.id)}" onclick="addToTeam('orange', ${player.id})">
                                        <i class="fas fa-tshirt"></i>
                                    </button>
                                    <button class="btn btn-sm btn-outline-primary" onclick="editPlayer(${player.id})">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                    <button class="btn btn-sm btn-outline-danger" onclick="removeFromList('second', ${player.id})">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </td>
                            </tr>
                        `;
                    }).join('')}
                </tbody>
            </table>
        `;
    }

    if (goalkeeperList) {
        goalkeeperList.innerHTML = `
            <div class="d-flex justify-content-between align-items-center mb-2">
                <h6>Goleiros: ${goalkeeperPlayers.length}/4</h6>
            </div>
            <table class="table table-light table-striped">
                <thead>
                    <tr>
                        <th>#</th>
                        <th>Nome</th>
                        <th>Posição</th>
                        <th>Horário</th>
                        <th>Valor</th>
                    </tr>
                </thead>
                <tbody>
                    ${goalkeeperPlayers.map((player, index) => {
                        const arrivalTime = player.arrivalTime || "";
                        const [hours, minutes] = arrivalTime.split(':').map(Number);
                        const isPriority = player.type === 'M' && 
                            (hours < 6 || (hours === 6 && minutes <= 30));
                        
                        const typeLabel = player.type === 'M' ? 'Mensalista' : player.type === 'D' ? 'Diarista' : '';
                        
                        return `
                            <tr>
                                <td>${index + 1}</td>
                                <td style="position: relative; padding-top: 16px;">
                                    ${isPriority ? '<div class="priority-badge">Prioridade Mensalista</div>' : ''}
                                    ${player.name}
                                    ${typeLabel ? `<div><small class="text-muted">(${typeLabel})</small></div>` : ''}
                                </td>
                                <td>${player.position}</td>
                                <td>${player.arrivalTime || '-'}</td>
                                <td>${player.price !== null ? `R$ ${Number(player.price || (player.type === 'M' ? 40 : 10)).toFixed(2)}` : '-'}</td>
                            </tr>
                            <tr>
                                <td colspan="5" class="text-center">
                                    <button class="btn btn-sm ${getTeamButtonStyle('blue', player.id)}" onclick="addToTeam('blue', ${player.id})">
                                        <i class="fas fa-tshirt"></i>
                                    </button>
                                    <button class="btn btn-sm ${getTeamButtonStyle('orange', player.id)}" onclick="addToTeam('orange', ${player.id})">
                                        <i class="fas fa-tshirt"></i>
                                    </button>
                                    <button class="btn btn-sm btn-outline-primary" onclick="editPlayer(${player.id})">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                    <button class="btn btn-sm btn-outline-danger" onclick="removeFromList('goalkeeper', ${player.id})">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </td>
                            </tr>
                        `;
                    }).join('')}
                </tbody>
            </table>
        `;
    }
}

function renderTeams() {
    const teamContainers = {
        blueTeam: document.getElementById('blueTeam'),
        orangeTeam: document.getElementById('orangeTeam'),
        blueTeamCopy: document.getElementById('blueTeamCopy'),
        orangeTeamCopy: document.getElementById('orangeTeamCopy'),
        blueTeamSecond: document.getElementById('blueTeamSecond'),
        orangeTeamSecond: document.getElementById('orangeTeamSecond')
    };

    // Helper function to render team list
    function renderTeamList(players, container) {
        if (!container) return;
        
        container.innerHTML = `
            <div class="list-group">
                ${players.map(player => `
                    <div class="list-group-item d-flex justify-content-between align-items-center">
                        <div>
                            ${player.name}
                            <small class="text-muted">(${player.position})</small>
                            ${player.type ? `<small class="text-muted"> - ${player.type === 'M' ? 'Mensalista' : 'Diarista'}</small>` : ''}
                        </div>
                        <button class="btn btn-sm btn-outline-danger" onclick="removeFromTeam('${player.id}')">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                `).join('')}
            </div>
        `;
    }

    // Render first half teams
    renderTeamList(blueTeam, teamContainers.blueTeam);
    renderTeamList(orangeTeam, teamContainers.orangeTeam);
    renderTeamList(blueTeam, teamContainers.blueTeamCopy);
    renderTeamList(orangeTeam, teamContainers.orangeTeamCopy);

    // Render second half teams if they exist
    renderTeamList(blueTeamSecond, teamContainers.blueTeamSecond);
    renderTeamList(orangeTeamSecond, teamContainers.orangeTeamSecond);
}

// Add function to remove player from team
function removeFromTeam(playerId) {
    // Remove from all teams
    blueTeam = blueTeam.filter(p => p.id !== playerId);
    orangeTeam = orangeTeam.filter(p => p.id !== playerId);
    blueTeamSecond = blueTeamSecond.filter(p => p.id !== playerId);
    orangeTeamSecond = orangeTeamSecond.filter(p => p.id !== playerId);

    // Save to localStorage
    localStorage.setItem('blueTeam', JSON.stringify(blueTeam));
    localStorage.setItem('orangeTeam', JSON.stringify(orangeTeam));
    localStorage.setItem('blueTeamSecond', JSON.stringify(blueTeamSecond));
    localStorage.setItem('orangeTeamSecond', JSON.stringify(orangeTeamSecond));

    // Update UI
    renderTeams();
    renderArrivalLists();
}

function showPositionCounts() {
    const floatingWindow = document.getElementById('floatingCountsWindow');
    const content = document.getElementById('floatingCountsContent');
    
    // Check if we're viewing second half or first half teams
    const secondHalfTab = document.querySelector('#segundoTempo.active');
    let teamBlue, teamOrange;
    
    if (secondHalfTab) {
        // Get teams from second half container if it exists
        const secondHalfContainer = document.getElementById('secondHalfTeamsContainer');
        if (secondHalfContainer && secondHalfContainer.style.display !== 'none') {
            const blueTeamSecondElem = document.getElementById('blueTeamSecond');
            const orangeTeamSecondElem = document.getElementById('orangeTeamSecond');
            
            // Parse the teams from the DOM elements
            teamBlue = Array.from(blueTeamSecondElem?.querySelectorAll('.list-group-item') || [])
                .map(item => ({
                    position: item.querySelector('.text-muted')?.textContent || ''
                }));
            
            teamOrange = Array.from(orangeTeamSecondElem?.querySelectorAll('.list-group-item') || [])
                .map(item => ({
                    position: item.querySelector('.text-muted')?.textContent || ''
                }));
        } else {
            teamBlue = blueTeamSecond;
            teamOrange = orangeTeamSecond;
        }
    } else {
        teamBlue = blueTeam;
        teamOrange = orangeTeam;
    }
    
    // Create or get the floating window
    if (!floatingWindow) {
        const div = document.createElement('div');
        div.id = 'floatingCountsWindow';
        div.className = 'floating-counts-window';
        div.innerHTML = `
            <span class="close-btn" onclick="this.parentElement.style.display='none'">&times;</span>
            <div id="floatingCountsContent"></div>
        `;
        document.body.appendChild(div);
    }
    
    const counts = generateTeamCountsHTML(
        getTeamPositionCounts(teamBlue),
        getTeamPositionCounts(teamOrange)
    );
    
    const floatingContent = document.getElementById('floatingCountsContent');
    if (floatingContent) {
        floatingContent.innerHTML = counts;
    }
    
    // Show the window
    document.getElementById('floatingCountsWindow').style.display = 'block';
    
    // Make the window draggable
    makeDraggable(document.getElementById('floatingCountsWindow'));
};

function makeDraggable(element) {
    let pos1 = 0, pos2 = 0, pos3 = 0, pos4 = 0;
    
    if (element.querySelector('.close-btn')) {
        element.querySelector('.close-btn').onmousedown = dragMouseDown;
    } else {
        element.onmousedown = dragMouseDown;
    }

    function dragMouseDown(e) {
        e = e || window.event;
        e.preventDefault();
        pos3 = e.clientX;
        pos4 = e.clientY;
        document.onmouseup = closeDragElement;
        document.onmousemove = elementDrag;
    }

    function elementDrag(e) {
        e = e || window.event;
        e.preventDefault();
        pos1 = pos3 - e.clientX;
        pos2 = pos4 - e.clientY;
        pos3 = e.clientX;
        pos4 = e.clientY;
        element.style.top = (element.offsetTop - pos2) + "px";
        element.style.left = (element.offsetLeft - pos1) + "px";
    }

    function closeDragElement() {
        document.onmouseup = null;
        document.onmousemove = null;
    }
}

function generateSecondHalfTeams() {
    const secondHalfContainer = document.getElementById('secondHalfTeamsContainer');
    if (secondHalfContainer) {
        secondHalfContainer.style.display = 'block';
    }

    // Get players from second half list
    const availablePlayers = [...secondHalfPlayers];
    
    // Clear existing second half teams
    blueTeamSecond = [];
    orangeTeamSecond = [];

    // Create balanced teams based on positions
    const positions = ['ATA', 'ZAG', 'LAT', 'MEI', 'VOL', 'GOL'];
    
    positions.forEach(position => {
        const positionPlayers = availablePlayers.filter(p => p.position === position);
        const count = positionPlayers.length;
        
        for (let i = 0; i < count; i++) {
            const player = positionPlayers[i];
            if (!player) continue;
            
            if (i % 2 === 0 && blueTeamSecond.length < 10) {
                blueTeamSecond.push(player);
            } else if (orangeTeamSecond.length < 10) {
                orangeTeamSecond.push(player);
            }
            
            // Remove added player from available players
            const index = availablePlayers.indexOf(player);
            if (index > -1) {
                availablePlayers.splice(index, 1);
            }
        }
    });

    // Save to localStorage
    localStorage.setItem('blueTeamSecond', JSON.stringify(blueTeamSecond));
    localStorage.setItem('orangeTeamSecond', JSON.stringify(orangeTeamSecond));

    // Update UI
    renderTeams();
}

// Attach event listeners
document.addEventListener('DOMContentLoaded', function() {
    renderPlayerList();
    renderArrivalLists();
    renderTeams();
    updateFinancialSummary();

    // Search functionality
    const searchPlayer = document.getElementById('searchPlayer');
    const playerSearchInput = document.getElementById('playerSearchInput');
    
    if (searchPlayer) {
        searchPlayer.addEventListener('input', (e) => handlePlayerSearch(e.target.value));
    }
    
    if (playerSearchInput) {
        playerSearchInput.addEventListener('input', (e) => handlePlayerSearch(e.target.value));
    }

    // Player form submission
    const playerForm = document.getElementById('playerForm');
    if (playerForm) {
        playerForm.addEventListener('submit', function(e) {
            e.preventDefault();
            const name = document.getElementById('playerName').value;
            const position = document.getElementById('playerPosition').value;
            const type = document.getElementById('playerType').value;

            const newPlayer = {
                id: Date.now(),
                name,
                position,
                type
            };

            players.push(newPlayer);
            localStorage.setItem('players', JSON.stringify(players));

            playerForm.reset();
            renderPlayerList();
        });
    }

    // Import/Export functionality
    const fileInput = document.getElementById('fileInput');
    if (fileInput) {
        fileInput.addEventListener('change', function(e) {
            const file = e.target.files[0];
            const reader = new FileReader();

            reader.onload = function(e) {
                const data = new Uint8Array(e.target.result);
                const workbook = XLSX.read(data, {type: 'array'});
                const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                const jsonData = XLSX.utils.sheet_to_json(firstSheet);

                players = jsonData.map(row => ({
                    id: Date.now() + Math.random(),
                    name: row.Nome,
                    position: row.Posição,
                    type: row.Tipo
                }));

                localStorage.setItem('players', JSON.stringify(players));
                renderPlayerList();
            };

            reader.readAsArrayBuffer(file);
        });
    }

    // Position filters
    document.addEventListener('click', function(e) {
        if (e.target.classList.contains('position-filter')) {
            const position = e.target.dataset.position;
            const listType = e.target.dataset.list;
            
            // Remove active class from all buttons in the same group
            e.target.parentElement.querySelectorAll('.position-filter').forEach(btn => {
                btn.classList.remove('active', 'btn-secondary');
                btn.classList.add('btn-outline-secondary');
            });
            
            // Add active class to clicked button
            e.target.classList.remove('btn-outline-secondary');
            e.target.classList.add('active', 'btn-secondary');
            
            // Filter the list
            const list = listType === 'first' ? firstHalfPlayers : 
                        listType === 'second' ? secondHalfPlayers : 
                        goalkeeperPlayers;
            
            const filteredList = position === 'Todos' ? 
                list : 
                list.filter(player => player.position === position);
            
            // Re-render the specific list
            if (listType === 'first') {
                const firstHalfList = document.getElementById('firstHalfList');
                // ... render first half list with filtered data
            } else if (listType === 'second') {
                const secondHalfList = document.getElementById('secondHalfList');
                // ... render second half list with filtered data
            }
        }
    });
});

window.clearAllLists = function() {
    if (!confirm('Tem certeza que deseja limpar todas as listas? Esta ação não pode ser desfeita.')) {
        return;
    }
    
    firstHalfPlayers = [];
    secondHalfPlayers = [];
    goalkeeperPlayers = [];
    blueTeam = [];
    orangeTeam = [];
    blueTeamSecond = [];
    orangeTeamSecond = [];
    
    localStorage.setItem('firstHalfPlayers', JSON.stringify(firstHalfPlayers));
    localStorage.setItem('secondHalfPlayers', JSON.stringify(secondHalfPlayers));
    localStorage.setItem('goalkeeperPlayers', JSON.stringify(goalkeeperPlayers));
    localStorage.setItem('blueTeam', JSON.stringify(blueTeam));
    localStorage.setItem('orangeTeam', JSON.stringify(orangeTeam));
    localStorage.setItem('blueTeamSecond', JSON.stringify(blueTeamSecond));
    localStorage.setItem('orangeTeamSecond', JSON.stringify(orangeTeamSecond));
    
    renderArrivalLists();
    renderTeams();
    updateFinancialSummary();
};

window.clearAllPlayers = function() {
    if (!confirm('Tem certeza que deseja apagar todos os jogadores? Esta ação não pode ser desfeita.')) {
        return;
    }
    
    players = [];
    localStorage.setItem('players', JSON.stringify(players));
    renderPlayerList();
};

window.exportToExcel = function() {
    const ws = XLSX.utils.json_to_sheet(players.map(p => ({
        Nome: p.name,
        Posição: p.position,
        Tipo: p.type
    })));
    
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, "Jogadores");
    
    XLSX.writeFile(wb, "jogadores.xlsx");
};

window.addToTeam = function(team, playerId) {
    let playerToAdd;
    const allPlayers = [...firstHalfPlayers, ...secondHalfPlayers, ...goalkeeperPlayers];
    playerToAdd = allPlayers.find(p => p.id === playerId);

    if (!playerToAdd) return;

    if (team === 'blue') {
        // Remove from orange team if present
        orangeTeam = orangeTeam.filter(p => p.id !== playerId);
        // Add to blue team if not already there
        if (!blueTeam.some(p => p.id === playerId)) {
            let updatedBlueTeam = [...blueTeam];
            updatedBlueTeam.push(playerToAdd);
            blueTeam = updatedBlueTeam;
        }
    } else {
        // Remove from blue team if present
        blueTeam = blueTeam.filter(p => p.id !== playerId);
        // Add to orange team if not already there
        if (!orangeTeam.some(p => p.id === playerId)) {
            let updatedOrangeTeam = [...orangeTeam];
            updatedOrangeTeam.push(playerToAdd);
            orangeTeam = updatedOrangeTeam;
        }
    }

    localStorage.setItem('blueTeam', JSON.stringify(blueTeam));
    localStorage.setItem('orangeTeam', JSON.stringify(orangeTeam));

    renderTeams();
    renderArrivalLists();
};

window.editPlayer = function(playerId) {
    // Implementation for editing player
    console.log('Edit player:', playerId);
};
</script>
</body>
</html>
